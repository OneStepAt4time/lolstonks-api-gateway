#!/bin/bash
#
# Git pre-push hook to enforce release standards
#
# This hook validates that tags follow proper versioning and
# that version files are updated before pushing tags.
#
# To install: ln -sf ../../.githooks/pre-push .git/hooks/pre-push
# Or run: git config core.hooksPath .githooks

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}Running pre-push hook...${NC}"

# Check if we're pushing tags
while read local_ref local_sha remote_ref remote_sha; do
    # Check if this is a tag
    if [[ $local_ref =~ refs/tags/ ]]; then
        tag_name=$(echo $local_ref | sed 's|refs/tags/||')
        echo -e "${YELLOW}Validating tag: $tag_name${NC}"

        # Extract version from tag (remove 'v' prefix)
        if [[ $tag_name =~ ^v([0-9]+\.[0-9]+\.[0-9]+.*) ]]; then
            tag_version="${BASH_REMATCH[1]}"
            echo "  Tag version: $tag_version"
        else
            echo -e "${RED}❌ Invalid tag format: $tag_name${NC}"
            echo "  Tags must be in format: v1.2.3, v1.2.3-dev.1, v1.2.3-alpha.1, etc."
            exit 1
        fi

        # Determine if this is a production or development release
        is_production=true
        if [[ $tag_version =~ -dev\.|alpha\.|beta\.|rc\. ]]; then
            is_production=false
            echo -e "  ${YELLOW}Development/Pre-release tag detected${NC}"
        else
            echo -e "  ${GREEN}Production release tag detected${NC}"
        fi

        # For production releases, enforce strict validation
        if [ "$is_production" = true ]; then
            echo -e "${YELLOW}Validating production release requirements...${NC}"

            # Check VERSION file
            if [ ! -f VERSION ]; then
                echo -e "${RED}❌ VERSION file not found${NC}"
                exit 1
            fi

            file_version=$(cat VERSION | tr -d '[:space:]')
            if [ "$file_version" != "$tag_version" ]; then
                echo -e "${RED}❌ Version mismatch!${NC}"
                echo "  VERSION file: $file_version"
                echo "  Git tag: $tag_version"
                echo ""
                echo "  Fix: python scripts/bump_version.py $tag_version"
                exit 1
            fi
            echo -e "  ${GREEN}✓ VERSION file matches tag${NC}"

            # Check pyproject.toml
            if [ -f pyproject.toml ]; then
                pyproject_version=$(grep -E '^version = ".*"' pyproject.toml | cut -d'"' -f2)
                if [ "$pyproject_version" != "$tag_version" ]; then
                    echo -e "${RED}❌ pyproject.toml version mismatch!${NC}"
                    echo "  pyproject.toml: $pyproject_version"
                    echo "  Git tag: $tag_version"
                    echo ""
                    echo "  Fix: python scripts/bump_version.py $tag_version"
                    exit 1
                fi
                echo -e "  ${GREEN}✓ pyproject.toml version matches tag${NC}"
            fi

            # Check app/__init__.py
            if [ -f app/__init__.py ]; then
                init_version=$(grep -E '__version__ = ".*"' app/__init__.py | cut -d'"' -f2)
                if [ "$init_version" != "$tag_version" ]; then
                    echo -e "${RED}❌ app/__init__.py version mismatch!${NC}"
                    echo "  app/__init__.py: $init_version"
                    echo "  Git tag: $tag_version"
                    echo ""
                    echo "  Fix: python scripts/bump_version.py $tag_version"
                    exit 1
                fi
                echo -e "  ${GREEN}✓ app/__init__.py version matches tag${NC}"
            fi

            # Check CHANGELOG.md
            if [ -f CHANGELOG.md ]; then
                if ! grep -q "## \[$tag_version\]" CHANGELOG.md; then
                    echo -e "${RED}❌ No CHANGELOG.md entry for version $tag_version${NC}"
                    echo ""
                    echo "  Please add a changelog entry for this version:"
                    echo "  ## [$tag_version] - $(date +%Y-%m-%d)"
                    exit 1
                fi
                echo -e "  ${GREEN}✓ CHANGELOG.md has entry for $tag_version${NC}"
            fi

            echo -e "${GREEN}✅ All production release validations passed!${NC}"
        else
            # Development releases - more lenient
            echo -e "${YELLOW}Development release - skipping strict version checks${NC}"
            echo -e "  ${YELLOW}⚠️  Ensure this is intended as a pre-release${NC}"
        fi

        echo ""
    fi
done

echo -e "${GREEN}✅ Pre-push hook passed${NC}"
exit 0
