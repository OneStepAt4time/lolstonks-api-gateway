name: Documentation Verification

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'tests/docs_verification/**'
      - '.github/workflows/docs-verification.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test (prod, dev, or both)'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
          - both
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'

jobs:
  verify-production:
    name: Verify Production Docs
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.environment == 'prod' || github.event.inputs.environment == 'both'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install UV
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: |
          uv sync --extra test-docs

      - name: Install Playwright browsers
        run: |
          uv run playwright install chromium
          uv run playwright install-deps

      - name: Run verification tests (Production)
        run: |
          uv run pytest tests/docs_verification/ \
            --env=prod \
            -v \
            --tb=short \
            --html=docs_verification_output/reports/prod/pytest-report.html \
            --self-contained-html
        continue-on-error: false

      - name: Upload production screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: production-screenshots
          path: docs_verification_output/screenshots/prod/
          retention-days: 30

      - name: Upload production reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: production-reports
          path: docs_verification_output/reports/prod/
          retention-days: 30

      - name: Comment PR with production results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'docs_verification_output/reports/prod/navigation-summary.md';

            let comment = '## ðŸ“Š Documentation Verification Results (Production)\n\n';

            if (fs.existsSync(path)) {
              const summary = fs.readFileSync(path, 'utf8');
              comment += summary;
            } else {
              comment += 'âš ï¸ Summary report not found. Check artifacts for details.';
            }

            comment += '\n\n---\n';
            comment += 'ðŸ“¸ Screenshots and detailed reports are available in the workflow artifacts.\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  verify-development:
    name: Verify Development Docs
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.environment == 'dev' || github.event.inputs.environment == 'both'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install UV
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: |
          uv sync --extra test-docs

      - name: Install Playwright browsers
        run: |
          uv run playwright install chromium
          uv run playwright install-deps

      - name: Run verification tests (Development)
        run: |
          uv run pytest tests/docs_verification/ \
            --env=dev \
            -v \
            --tb=short \
            --html=docs_verification_output/reports/dev/pytest-report.html \
            --self-contained-html
        continue-on-error: false

      - name: Upload development screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: development-screenshots
          path: docs_verification_output/screenshots/dev/
          retention-days: 30

      - name: Upload development reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: development-reports
          path: docs_verification_output/reports/dev/
          retention-days: 30

  verify-local-build:
    name: Verify Local Build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install UV
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: |
          uv sync --extra docs --extra test-docs

      - name: Export OpenAPI schema
        run: |
          uv run python scripts/export_openapi.py

      - name: Build documentation
        run: |
          uv run mkdocs build --strict

      - name: Serve documentation (background)
        run: |
          uv run mkdocs serve --dev-addr=127.0.0.1:8000 &
          echo $! > mkdocs.pid
          sleep 5

      - name: Install Playwright browsers
        run: |
          uv run playwright install chromium
          uv run playwright install-deps

      - name: Run verification tests (Local Build)
        run: |
          uv run pytest tests/docs_verification/ \
            --env=prod \
            --base-url=http://127.0.0.1:8000 \
            -v \
            --tb=short \
            --html=docs_verification_output/reports/local/pytest-report.html \
            --self-contained-html

      - name: Stop MkDocs server
        if: always()
        run: |
          if [ -f mkdocs.pid ]; then
            kill $(cat mkdocs.pid) || true
          fi

      - name: Upload local build screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: local-build-screenshots
          path: docs_verification_output/screenshots/prod/
          retention-days: 7

      - name: Upload local build reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: local-build-reports
          path: docs_verification_output/reports/local/
          retention-days: 7

  comparison-report:
    name: Generate Comparison Report
    runs-on: ubuntu-latest
    needs: [verify-production, verify-development]
    if: always() && (github.event_name != 'workflow_dispatch' || github.event.inputs.environment == 'both')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download production reports
        uses: actions/download-artifact@v4
        with:
          name: production-reports
          path: prod-reports/

      - name: Download development reports
        uses: actions/download-artifact@v4
        with:
          name: development-reports
          path: dev-reports/

      - name: Generate comparison report
        run: |
          mkdir -p comparison/
          cat > comparison/comparison-report.md << 'EOF'
          # Documentation Verification Comparison

          ## Production vs Development

          This report compares documentation quality between production (main branch) and development (dev branch).

          ### Production Status
          EOF

          if [ -f prod-reports/navigation-summary.md ]; then
            cat prod-reports/navigation-summary.md >> comparison/comparison-report.md
          else
            echo "âš ï¸ Production summary not available" >> comparison/comparison-report.md
          fi

          echo -e "\n---\n" >> comparison/comparison-report.md
          echo "### Development Status" >> comparison/comparison-report.md

          if [ -f dev-reports/navigation-summary.md ]; then
            cat dev-reports/navigation-summary.md >> comparison/comparison-report.md
          else
            echo "âš ï¸ Development summary not available" >> comparison/comparison-report.md
          fi

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: comparison/
          retention-days: 30

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [verify-production, verify-development, verify-local-build]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## Documentation Verification Complete"
          echo ""
          echo "Check the following artifacts for detailed results:"
          echo "- production-screenshots"
          echo "- production-reports"
          echo "- development-screenshots (if applicable)"
          echo "- development-reports (if applicable)"
          echo "- local-build-screenshots (if PR)"
          echo "- local-build-reports (if PR)"
          echo "- comparison-report (if both environments tested)"
