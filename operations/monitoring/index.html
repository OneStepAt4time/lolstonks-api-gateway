
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Unified League of Legends API Gateway with caching, rate limiting, and comprehensive monitoring" name="description"/>
<link href="../../architecture/models/" rel="prev"/>
<link href="../troubleshooting/" rel="next"/>
<link href="../../assets/logo.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.23" name="generator"/>
<title>Monitoring - LOLStonks API Gateway</title>
<link href="../../assets/stylesheets/main.84d31ad4.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../assets/_mkdocstrings.css" rel="stylesheet"/>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="blue" data-md-color-primary="blue" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#monitoring-and-observability">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="LOLStonks API Gateway" class="md-header__button md-logo" data-md-component="logo" href="../.." title="LOLStonks API Gateway">
<img alt="logo" src="../../assets/logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            LOLStonks API Gateway
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Monitoring
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="blue" data-md-color-media="" data-md-color-primary="blue" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="blue" data-md-color-media="" data-md-color-primary="blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/OneStepAt4time/lolstonks-api-gateway" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../..">
        
  
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../CHANGELOG.md">
        
  
  
    
  
  Changelog

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../getting-started/installation/">
          
  
  
    
  
  Getting Started

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../api/openapi-spec/">
          
  
  
    
  
  API Reference

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../architecture/overview/">
          
  
  
    
  
  Architecture

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="./">
          
  
  
    
  
  Operations

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../development/contributing/">
          
  
  
    
  
  Development

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="LOLStonks API Gateway" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="LOLStonks API Gateway">
<img alt="logo" src="../../assets/logo.png"/>
</a>
    LOLStonks API Gateway
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/OneStepAt4time/lolstonks-api-gateway" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
<span class="md-ellipsis">
    Home
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../CHANGELOG.md">
<span class="md-ellipsis">
    Changelog
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    Getting Started
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/installation/">
<span class="md-ellipsis">
    Installation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/quick-start/">
<span class="md-ellipsis">
    Quick Start
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/configuration/">
<span class="md-ellipsis">
    Configuration
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/deployment/">
<span class="md-ellipsis">
    Production Deployment
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    API Reference
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/openapi-spec/">
<span class="md-ellipsis">
    OpenAPI Specification
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/overview/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/providers/">
<span class="md-ellipsis">
    Providers
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/riot-client/">
<span class="md-ellipsis">
    Riot Client
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/models/">
<span class="md-ellipsis">
    Models
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/routers/">
<span class="md-ellipsis">
    Routers
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/cache/">
<span class="md-ellipsis">
    Cache
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/security/">
<span class="md-ellipsis">
    Security
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Architecture
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Architecture
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/overview/">
<span class="md-ellipsis">
    Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/diagram-guide.md">
<span class="md-ellipsis">
    Diagram Guide
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/system-overview.md">
<span class="md-ellipsis">
    System Overview
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/data-flow.md">
<span class="md-ellipsis">
    Data Flow
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/implementation-details/">
<span class="md-ellipsis">
    Implementation Details
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/models/">
<span class="md-ellipsis">
    Data Models
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
<span class="md-ellipsis">
    Operations
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            Operations
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Monitoring
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    Monitoring
    
  </span>
</a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      Overview
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#core-monitoring-components">
<span class="md-ellipsis">
      Core Monitoring Components
    </span>
</a>
<nav aria-label="Core Monitoring Components" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-application-metrics">
<span class="md-ellipsis">
      1. Application Metrics
    </span>
</a>
<nav aria-label="1. Application Metrics" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#key-performance-indicators-kpis">
<span class="md-ellipsis">
      Key Performance Indicators (KPIs)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#custom-metrics-implementation">
<span class="md-ellipsis">
      Custom Metrics Implementation
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-health-checks">
<span class="md-ellipsis">
      2. Health Checks
    </span>
</a>
<nav aria-label="2. Health Checks" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#current-implementation">
<span class="md-ellipsis">
      Current Implementation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#comprehensive-health-endpoint-potential-enhancement">
<span class="md-ellipsis">
      Comprehensive Health Endpoint (Potential Enhancement)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-logging-strategy">
<span class="md-ellipsis">
      3. Logging Strategy
    </span>
</a>
<nav aria-label="3. Logging Strategy" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#current-implementation_1">
<span class="md-ellipsis">
      Current Implementation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#structured-logging-configuration-potential-enhancement">
<span class="md-ellipsis">
      Structured Logging Configuration (Potential Enhancement)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#request-logging-middleware">
<span class="md-ellipsis">
      Request Logging Middleware
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#monitoring-setup">
<span class="md-ellipsis">
      Monitoring Setup
    </span>
</a>
<nav aria-label="Monitoring Setup" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#prometheus-configuration">
<span class="md-ellipsis">
      Prometheus Configuration
    </span>
</a>
<nav aria-label="Prometheus Configuration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#prometheusyml-example-configuration">
<span class="md-ellipsis">
      prometheus.yml (Example Configuration)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#alert-rules">
<span class="md-ellipsis">
      Alert Rules
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#grafana-dashboard">
<span class="md-ellipsis">
      Grafana Dashboard
    </span>
</a>
<nav aria-label="Grafana Dashboard" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dashboard-configuration-example">
<span class="md-ellipsis">
      Dashboard Configuration (Example)
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#log-management">
<span class="md-ellipsis">
      Log Management
    </span>
</a>
<nav aria-label="Log Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#log-aggregation-with-elk-stack-example">
<span class="md-ellipsis">
      Log Aggregation with ELK Stack (Example)
    </span>
</a>
<nav aria-label="Log Aggregation with ELK Stack (Example)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#logstash-configuration-example">
<span class="md-ellipsis">
      Logstash Configuration (Example)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kibana-dashboard-configuration">
<span class="md-ellipsis">
      Kibana Dashboard Configuration
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#advanced-monitoring">
<span class="md-ellipsis">
      Advanced Monitoring
    </span>
</a>
<nav aria-label="Advanced Monitoring" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#distributed-tracing-with-opentelemetry-potential-enhancement">
<span class="md-ellipsis">
      Distributed Tracing with OpenTelemetry (Potential Enhancement)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#custom-metrics-potential-enhancement">
<span class="md-ellipsis">
      Custom Metrics (Potential Enhancement)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#alerting">
<span class="md-ellipsis">
      Alerting
    </span>
</a>
<nav aria-label="Alerting" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#alert-configuration-example">
<span class="md-ellipsis">
      Alert Configuration (Example)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#notification-channels">
<span class="md-ellipsis">
      Notification Channels
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#summary">
<span class="md-ellipsis">
      Summary
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../troubleshooting/">
<span class="md-ellipsis">
    Troubleshooting
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../security/">
<span class="md-ellipsis">
    Security
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
<span class="md-ellipsis">
    Development
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_7_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
            Development
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/contributing/">
<span class="md-ellipsis">
    Contributing
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/changelog-guide/">
<span class="md-ellipsis">
    Changelog Guide
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/versioning/">
<span class="md-ellipsis">
    Versioning
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/releases/">
<span class="md-ellipsis">
    Releases
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/testing/">
<span class="md-ellipsis">
    Testing
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../development/documentation/">
<span class="md-ellipsis">
    Documentation
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#overview">
<span class="md-ellipsis">
      Overview
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#core-monitoring-components">
<span class="md-ellipsis">
      Core Monitoring Components
    </span>
</a>
<nav aria-label="Core Monitoring Components" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#1-application-metrics">
<span class="md-ellipsis">
      1. Application Metrics
    </span>
</a>
<nav aria-label="1. Application Metrics" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#key-performance-indicators-kpis">
<span class="md-ellipsis">
      Key Performance Indicators (KPIs)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#custom-metrics-implementation">
<span class="md-ellipsis">
      Custom Metrics Implementation
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#2-health-checks">
<span class="md-ellipsis">
      2. Health Checks
    </span>
</a>
<nav aria-label="2. Health Checks" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#current-implementation">
<span class="md-ellipsis">
      Current Implementation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#comprehensive-health-endpoint-potential-enhancement">
<span class="md-ellipsis">
      Comprehensive Health Endpoint (Potential Enhancement)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#3-logging-strategy">
<span class="md-ellipsis">
      3. Logging Strategy
    </span>
</a>
<nav aria-label="3. Logging Strategy" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#current-implementation_1">
<span class="md-ellipsis">
      Current Implementation
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#structured-logging-configuration-potential-enhancement">
<span class="md-ellipsis">
      Structured Logging Configuration (Potential Enhancement)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#request-logging-middleware">
<span class="md-ellipsis">
      Request Logging Middleware
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#monitoring-setup">
<span class="md-ellipsis">
      Monitoring Setup
    </span>
</a>
<nav aria-label="Monitoring Setup" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#prometheus-configuration">
<span class="md-ellipsis">
      Prometheus Configuration
    </span>
</a>
<nav aria-label="Prometheus Configuration" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#prometheusyml-example-configuration">
<span class="md-ellipsis">
      prometheus.yml (Example Configuration)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#alert-rules">
<span class="md-ellipsis">
      Alert Rules
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#grafana-dashboard">
<span class="md-ellipsis">
      Grafana Dashboard
    </span>
</a>
<nav aria-label="Grafana Dashboard" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dashboard-configuration-example">
<span class="md-ellipsis">
      Dashboard Configuration (Example)
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#log-management">
<span class="md-ellipsis">
      Log Management
    </span>
</a>
<nav aria-label="Log Management" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#log-aggregation-with-elk-stack-example">
<span class="md-ellipsis">
      Log Aggregation with ELK Stack (Example)
    </span>
</a>
<nav aria-label="Log Aggregation with ELK Stack (Example)" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#logstash-configuration-example">
<span class="md-ellipsis">
      Logstash Configuration (Example)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#kibana-dashboard-configuration">
<span class="md-ellipsis">
      Kibana Dashboard Configuration
    </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#advanced-monitoring">
<span class="md-ellipsis">
      Advanced Monitoring
    </span>
</a>
<nav aria-label="Advanced Monitoring" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#distributed-tracing-with-opentelemetry-potential-enhancement">
<span class="md-ellipsis">
      Distributed Tracing with OpenTelemetry (Potential Enhancement)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#custom-metrics-potential-enhancement">
<span class="md-ellipsis">
      Custom Metrics (Potential Enhancement)
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#alerting">
<span class="md-ellipsis">
      Alerting
    </span>
</a>
<nav aria-label="Alerting" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#alert-configuration-example">
<span class="md-ellipsis">
      Alert Configuration (Example)
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#notification-channels">
<span class="md-ellipsis">
      Notification Channels
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#summary">
<span class="md-ellipsis">
      Summary
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="monitoring-and-observability">Monitoring and Observability<a class="headerlink" href="#monitoring-and-observability" title="Permanent link">¬∂</a></h1>
<p>This guide covers monitoring, logging, and observability for the LOLStonks API Gateway in production environments.</p>
<blockquote>
<p><strong>üìù Documentation Note</strong>: This document describes <strong>best practices and potential implementations</strong> for production monitoring. Many of these features represent future enhancements rather than current implementation.</p>
<p><strong>Currently Implemented</strong> ‚úÖ:
- Basic health check endpoint (<code>/health</code> returns <code>{"status": "ok"}</code>)
- Loguru logging to stderr
- Basic application startup/shutdown logging</p>
<p><strong>Not Yet Implemented</strong> ‚ùå (Potential Future Enhancements):
- Prometheus metrics collection
- Grafana dashboards
- ELK stack integration
- OpenTelemetry distributed tracing
- Advanced health checks (Redis/Riot API status)
- Custom metrics middleware</p>
<p>For actual implementation details, see <a href="../../architecture/implementation-details/">Implementation Details</a>.</p>
</blockquote>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">¬∂</a></h2>
<p>Effective monitoring ensures:
- <strong>Proactive Issue Detection</strong>: Identify problems before users notice
- <strong>Performance Optimization</strong>: Track and optimize system performance
- <strong>Capacity Planning</strong>: Understand resource usage and scaling needs
- <strong>Security Monitoring</strong>: Detect unusual activity and potential threats</p>
<h2 id="core-monitoring-components">Core Monitoring Components<a class="headerlink" href="#core-monitoring-components" title="Permanent link">¬∂</a></h2>
<h3 id="1-application-metrics">1. Application Metrics<a class="headerlink" href="#1-application-metrics" title="Permanent link">¬∂</a></h3>
<h4 id="key-performance-indicators-kpis">Key Performance Indicators (KPIs)<a class="headerlink" href="#key-performance-indicators-kpis" title="Permanent link">¬∂</a></h4>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Description</th>
<th>Target</th>
<th>Alert Threshold</th>
</tr>
</thead>
<tbody>
<tr>
<td>Request Rate</td>
<td>API requests per second</td>
<td>Variable</td>
<td>&gt; 1000 req/s</td>
</tr>
<tr>
<td>Response Time</td>
<td>Average API response time</td>
<td>&lt; 200ms</td>
<td>&gt; 500ms</td>
</tr>
<tr>
<td>Error Rate</td>
<td>Percentage of failed requests</td>
<td>&lt; 1%</td>
<td>&gt; 5%</td>
</tr>
<tr>
<td>Cache Hit Rate</td>
<td>Percentage of requests served from cache</td>
<td>&gt; 80%</td>
<td>&lt; 60%</td>
</tr>
<tr>
<td>Memory Usage</td>
<td>Application memory consumption</td>
<td>&lt; 2GB</td>
<td>&gt; 3GB</td>
</tr>
<tr>
<td>CPU Usage</td>
<td>Application CPU utilization</td>
<td>&lt; 70%</td>
<td>&gt; 85%</td>
</tr>
</tbody>
</table>
<h4 id="custom-metrics-implementation">Custom Metrics Implementation<a class="headerlink" href="#custom-metrics-implementation" title="Permanent link">¬∂</a></h4>
<blockquote>
<p><strong>üí° Potential Implementation</strong>: The code below shows how to implement Prometheus metrics. This is <strong>not currently implemented</strong> in the codebase.</p>
</blockquote>
<pre><code class="language-python"># Example: app/monitoring.py (NOT IMPLEMENTED)
from prometheus_client import Counter, Histogram, Gauge, generate_latest
import time
import logging

# Define metrics
REQUEST_COUNT = Counter(
    'lolstonks_requests_total',
    'Total number of API requests',
    ['method', 'endpoint', 'status']
)

REQUEST_DURATION = Histogram(
    'lolstonks_request_duration_seconds',
    'Request duration in seconds',
    ['method', 'endpoint']
)

CACHE_HIT_RATE = Gauge(
    'lolstonks_cache_hit_rate',
    'Cache hit rate percentage'
)

ACTIVE_CONNECTIONS = Gauge(
    'lolstonks_active_connections',
    'Number of active connections'
)

class MetricsMiddleware:
    def __init__(self, app):
        self.app = app

    async def __call__(self, scope, receive, send):
        if scope["type"] == "http":
            start_time = time.time()

            # Process request
            await self.app(scope, receive, send)

            # Record metrics
            duration = time.time() - start_time
            REQUEST_DURATION.labels(
                method=scope["method"],
                endpoint=scope["path"]
            ).observe(duration)

            REQUEST_COUNT.labels(
                method=scope["method"],
                endpoint=scope["path"],
                status="200"  # Would be set from actual response
            ).inc()
        else:
            await self.app(scope, receive, send)
</code></pre>
<h3 id="2-health-checks">2. Health Checks<a class="headerlink" href="#2-health-checks" title="Permanent link">¬∂</a></h3>
<h4 id="current-implementation">Current Implementation<a class="headerlink" href="#current-implementation" title="Permanent link">¬∂</a></h4>
<p>The actual health check endpoint is very simple:</p>
<pre><code class="language-python"># app/routers/health.py (ACTUAL IMPLEMENTATION)
@router.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "ok"}
</code></pre>
<h4 id="comprehensive-health-endpoint-potential-enhancement">Comprehensive Health Endpoint (Potential Enhancement)<a class="headerlink" href="#comprehensive-health-endpoint-potential-enhancement" title="Permanent link">¬∂</a></h4>
<blockquote>
<p><strong>üí° Potential Implementation</strong>: Below is an example of an advanced health check. This is <strong>not currently implemented</strong>.</p>
</blockquote>
<pre><code class="language-python"># Example: Comprehensive health check (NOT IMPLEMENTED)
from fastapi import APIRouter, Depends
from app.cache.redis_cache import RedisCache
from app.riot.client import RiotClient
import asyncio
import time

router = APIRouter()

@router.get("/health")
async def health_check():
    """Comprehensive health check endpoint."""
    start_time = time.time()

    health_status = {
        "status": "healthy",
        "timestamp": time.time(),
        "version": "1.0.0",
        "checks": {},
        "duration_ms": 0
    }

    # Check Redis
    try:
        redis_health = await check_redis_health()
        health_status["checks"]["redis"] = redis_health
    except Exception as e:
        health_status["checks"]["redis"] = {
            "status": "unhealthy",
            "error": str(e)
        }
        health_status["status"] = "degraded"

    # Check Riot API connectivity
    try:
        riot_health = await check_riot_api_health()
        health_status["checks"]["riot_api"] = riot_health
    except Exception as e:
        health_status["checks"]["riot_api"] = {
            "status": "unhealthy",
            "error": str(e)
        }
        health_status["status"] = "degraded"

    # Check system resources
    try:
        system_health = check_system_health()
        health_status["checks"]["system"] = system_health
    except Exception as e:
        health_status["checks"]["system"] = {
            "status": "unhealthy",
            "error": str(e)
        }
        health_status["status"] = "unhealthy"

    health_status["duration_ms"] = int((time.time() - start_time) * 1000)

    return health_status

async def check_redis_health():
    """Check Redis connectivity and performance."""
    cache = RedisCache()

    # Test basic connectivity
    start_time = time.time()
    await cache.set("health_check", "ok", ttl=10)
    result = await cache.get("health_check")
    duration = time.time() - start_time

    if result != "ok":
        raise Exception("Redis read/write test failed")

    # Get Redis info
    import redis
    redis_client = redis.Redis(
        host=cache.redis_host,
        port=cache.redis_port,
        password=cache.redis_password,
        decode_responses=True
    )

    info = redis_client.info()

    return {
        "status": "healthy",
        "response_time_ms": int(duration * 1000),
        "memory_usage": info.get("used_memory_human"),
        "connected_clients": info.get("connected_clients"),
        "uptime_seconds": info.get("uptime_in_seconds")
    }

async def check_riot_api_health():
    """Check Riot API connectivity."""
    client = RiotClient()

    start_time = time.time()
    response = await client.get(
        "/lol/status/v4/platform-data",
        region="na1"
    )
    duration = time.time() - start_time

    if response.status_code != 200:
        raise Exception(f"Riot API returned status {response.status_code}")

    return {
        "status": "healthy",
        "response_time_ms": int(duration * 1000),
        "status_code": response.status_code
    }

def check_system_health():
    """Check system resources."""
    import psutil

    # CPU usage
    cpu_percent = psutil.cpu_percent(interval=1)

    # Memory usage
    memory = psutil.virtual_memory()
    disk = psutil.disk_usage('/')

    # Network connections
    connections = len(psutil.net_connections())

    system_health = {
        "status": "healthy",
        "cpu_percent": cpu_percent,
        "memory_percent": memory.percent,
        "memory_available_gb": round(memory.available / (1024**3), 2),
        "disk_percent": disk.percent,
        "disk_free_gb": round(disk.free / (1024**3), 2),
        "network_connections": connections
    }

    # Determine overall status
    if cpu_percent &gt; 90 or memory.percent &gt; 90 or disk.percent &gt; 90:
        system_health["status"] = "critical"
    elif cpu_percent &gt; 80 or memory.percent &gt; 80 or disk.percent &gt; 80:
        system_health["status"] = "warning"

    return system_health
</code></pre>
<h3 id="3-logging-strategy">3. Logging Strategy<a class="headerlink" href="#3-logging-strategy" title="Permanent link">¬∂</a></h3>
<h4 id="current-implementation_1">Current Implementation<a class="headerlink" href="#current-implementation_1" title="Permanent link">¬∂</a></h4>
<p>The application uses Loguru for logging:</p>
<pre><code class="language-python"># app/main.py (ACTUAL IMPLEMENTATION)
from loguru import logger

logger.remove()  # Remove default handler
logger.add(
    sys.stderr,
    format="&lt;green&gt;{time:YYYY-MM-DD HH:mm:ss}&lt;/green&gt; | &lt;level&gt;{level: &lt;8}&lt;/level&gt; | &lt;cyan&gt;{name}&lt;/cyan&gt;:&lt;cyan&gt;{function}&lt;/cyan&gt; - &lt;level&gt;{message}&lt;/level&gt;",
    level=settings.log_level,
    colorize=True,
)
</code></pre>
<h4 id="structured-logging-configuration-potential-enhancement">Structured Logging Configuration (Potential Enhancement)<a class="headerlink" href="#structured-logging-configuration-potential-enhancement" title="Permanent link">¬∂</a></h4>
<blockquote>
<p><strong>üí° Potential Implementation</strong>: Below is an example of JSON structured logging. This is <strong>not currently implemented</strong>.</p>
</blockquote>
<pre><code class="language-python"># Example: app/logging_config.py (NOT IMPLEMENTED)
import logging
import json
import sys
from datetime import datetime
from pathlib import Path

class JSONFormatter(logging.Formatter):
    def format(self, record):
        log_entry = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno
        }

        # Add exception info if present
        if record.exc_info:
            log_entry["exception"] = self.formatException(record.exc_info)

        # Add extra fields
        for key, value in record.__dict__.items():
            if key not in ['name', 'msg', 'args', 'levelname', 'levelno',
                          'pathname', 'filename', 'module', 'exc_info',
                          'exc_text', 'stack_info', 'lineno', 'funcName',
                          'created', 'msecs', 'relativeCreated', 'thread',
                          'threadName', 'processName', 'process', 'message']:
                log_entry[key] = value

        return json.dumps(log_entry)

def setup_logging():
    """Configure structured logging for the application."""

    # Create logs directory
    log_dir = Path("/var/log/lolstonks")
    log_dir.mkdir(exist_ok=True)

    # Configure root logger
    logging.basicConfig(
        level=logging.INFO,
        handlers=[
            logging.StreamHandler(sys.stdout),
            logging.FileHandler(log_dir / "api.log")
        ]
    )

    # Set JSON formatter for all handlers
    for handler in logging.root.handlers:
        handler.setFormatter(JSONFormatter())

    # Configure specific loggers
    loggers = [
        "uvicorn.access",
        "uvicorn.error",
        "app.riot.client",
        "app.cache.redis_cache"
    ]

    for logger_name in loggers:
        logger = logging.getLogger(logger_name)
        logger.setLevel(logging.INFO)
</code></pre>
<h4 id="request-logging-middleware">Request Logging Middleware<a class="headerlink" href="#request-logging-middleware" title="Permanent link">¬∂</a></h4>
<pre><code class="language-python"># app/middleware.py
import time
import uuid
from fastapi import Request, Response
from starlette.middleware.base import BaseHTTPMiddleware

class RequestLoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        # Generate unique request ID
        request_id = str(uuid.uuid4())

        # Log request start
        start_time = time.time()

        logger = logging.getLogger("request")
        logger.info(
            "Request started",
            extra={
                "request_id": request_id,
                "method": request.method,
                "url": str(request.url),
                "client_ip": request.client.host,
                "user_agent": request.headers.get("user-agent")
            }
        )

        try:
            # Process request
            response = await call_next(request)

            # Calculate duration
            duration = time.time() - start_time

            # Log request completion
            logger.info(
                "Request completed",
                extra={
                    "request_id": request_id,
                    "method": request.method,
                    "url": str(request.url),
                    "status_code": response.status_code,
                    "duration_ms": int(duration * 1000),
                    "response_size": response.headers.get("content-length", 0)
                }
            )

            # Add request ID to response headers
            response.headers["X-Request-ID"] = request_id

            return response

        except Exception as e:
            # Log request error
            duration = time.time() - start_time
            logger.error(
                "Request failed",
                extra={
                    "request_id": request_id,
                    "method": request.method,
                    "url": str(request.url),
                    "duration_ms": int(duration * 1000),
                    "error": str(e),
                    "error_type": type(e).__name__
                }
            )
            raise
</code></pre>
<h2 id="monitoring-setup">Monitoring Setup<a class="headerlink" href="#monitoring-setup" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>üí° Section Note</strong>: The monitoring tools described below (Prometheus, Grafana, ELK, OpenTelemetry) are <strong>not currently implemented</strong>. These are best practices and examples for potential future implementation.</p>
</blockquote>
<h3 id="prometheus-configuration">Prometheus Configuration<a class="headerlink" href="#prometheus-configuration" title="Permanent link">¬∂</a></h3>
<blockquote>
<p><strong>Not Implemented</strong>: Prometheus is not currently set up for this project.</p>
</blockquote>
<h4 id="prometheusyml-example-configuration">prometheus.yml (Example Configuration)<a class="headerlink" href="#prometheusyml-example-configuration" title="Permanent link">¬∂</a></h4>
<pre><code class="language-yaml">global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

scrape_configs:
  - job_name: 'lolstonks-api'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: '/metrics'
    scrape_interval: 5s
    scrape_timeout: 5s

  - job_name: 'redis'
    static_configs:
      - targets: ['localhost:9121']

  - job_name: 'node'
    static_configs:
      - targets: ['localhost:9100']
</code></pre>
<h4 id="alert-rules">Alert Rules<a class="headerlink" href="#alert-rules" title="Permanent link">¬∂</a></h4>
<pre><code class="language-yaml"># alert_rules.yml
groups:
  - name: lolstonks_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(lolstonks_requests_total{status!~"2.."}[5m]) / rate(lolstonks_requests_total[5m]) &gt; 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} for the last 5 minutes"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(lolstonks_request_duration_seconds_bucket[5m])) &gt; 0.5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }}s"

      - alert: LowCacheHitRate
        expr: lolstonks_cache_hit_rate &lt; 0.6
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }}"

      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 &gt; 3000
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}MB"

      - alert: ServiceDown
        expr: up{job="lolstonks-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service is down"
          description: "LOLStonks API Gateway has been down for more than 1 minute"
</code></pre>
<h3 id="grafana-dashboard">Grafana Dashboard<a class="headerlink" href="#grafana-dashboard" title="Permanent link">¬∂</a></h3>
<blockquote>
<p><strong>Not Implemented</strong>: Grafana dashboards are not currently configured.</p>
</blockquote>
<h4 id="dashboard-configuration-example">Dashboard Configuration (Example)<a class="headerlink" href="#dashboard-configuration-example" title="Permanent link">¬∂</a></h4>
<pre><code class="language-json">{
  "dashboard": {
    "id": null,
    "title": "LOLStonks API Gateway",
    "tags": ["lolstonks", "api"],
    "timezone": "browser",
    "panels": [
      {
        "title": "Request Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(lolstonks_requests_total[5m])",
            "legendFormat": "{{method}} {{endpoint}}"
          }
        ],
        "yAxes": [
          {
            "label": "Requests/sec"
          }
        ]
      },
      {
        "title": "Response Time",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(lolstonks_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          },
          {
            "expr": "histogram_quantile(0.50, rate(lolstonks_request_duration_seconds_bucket[5m]))",
            "legendFormat": "50th percentile"
          }
        ],
        "yAxes": [
          {
            "label": "Seconds"
          }
        ]
      },
      {
        "title": "Error Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(lolstonks_requests_total{status!~\"2..\"}[5m]) / rate(lolstonks_requests_total[5m])",
            "legendFormat": "Error Rate"
          }
        ],
        "yAxes": [
          {
            "label": "Percentage",
            "max": 1,
            "min": 0
          }
        ]
      },
      {
        "title": "Cache Hit Rate",
        "type": "singlestat",
        "targets": [
          {
            "expr": "lolstonks_cache_hit_rate",
            "legendFormat": "Cache Hit Rate"
          }
        ],
        "valueMaps": [
          {
            "value": "null",
            "text": "N/A"
          }
        ],
        "thresholds": "0.6,0.8"
      },
      {
        "title": "Memory Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "process_resident_memory_bytes / 1024 / 1024",
            "legendFormat": "Memory (MB)"
          }
        ],
        "yAxes": [
          {
            "label": "MB"
          }
        ]
      },
      {
        "title": "CPU Usage",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(process_cpu_seconds_total[5m]) * 100",
            "legendFormat": "CPU %"
          }
        ],
        "yAxes": [
          {
            "label": "Percentage",
            "max": 100,
            "min": 0
          }
        ]
      }
    ],
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "refresh": "5s"
  }
}
</code></pre>
<h2 id="log-management">Log Management<a class="headerlink" href="#log-management" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>Not Implemented</strong>: ELK Stack (Elasticsearch, Logstash, Kibana) is not currently configured.</p>
</blockquote>
<h3 id="log-aggregation-with-elk-stack-example">Log Aggregation with ELK Stack (Example)<a class="headerlink" href="#log-aggregation-with-elk-stack-example" title="Permanent link">¬∂</a></h3>
<h4 id="logstash-configuration-example">Logstash Configuration (Example)<a class="headerlink" href="#logstash-configuration-example" title="Permanent link">¬∂</a></h4>
<pre><code class="language-ruby"># logstash.conf
input {
  file {
    path =&gt; "/var/log/lolstonks/api.log"
    start_position =&gt; "beginning"
    codec =&gt; json
  }
}

filter {
  # Parse timestamp
  date {
    match =&gt; [ "timestamp", "ISO8601" ]
  }

  # Add fields
  mutate {
    add_field =&gt; { "service" =&gt; "lolstonks-api" }
    add_field =&gt; { "environment" =&gt; "production" }
  }

  # Parse request logs
  if [request_id] {
    mutate {
      add_field =&gt; { "log_type" =&gt; "request" }
    }
  }

  # Parse error logs
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_field =&gt; { "log_type" =&gt; "error" }
    }
  }
}

output {
  elasticsearch {
    hosts =&gt; ["elasticsearch:9200"]
    index =&gt; "lolstonks-logs-%{+YYYY.MM.dd}"
  }

  # Also output to stdout for debugging
  stdout {
    codec =&gt; rubydebug
  }
}
</code></pre>
<h4 id="kibana-dashboard-configuration">Kibana Dashboard Configuration<a class="headerlink" href="#kibana-dashboard-configuration" title="Permanent link">¬∂</a></h4>
<pre><code class="language-javascript">// Kibana saved objects for LOLStonks monitoring
{
  "dashboard": {
    "title": "LOLStonks Logs",
    "panels": [
      {
        "title": "Request Rate Over Time",
        "type": "histogram",
        "query": "log_type:request",
        "timeField": "@timestamp"
      },
      {
        "title": "Error Distribution",
        "type": "pie",
        "query": "level:ERROR OR level:CRITICAL",
        "field": "error_type"
      },
      {
        "title": "Response Time Distribution",
        "type": "histogram",
        "query": "duration_ms:*",
        "field": "duration_ms"
      },
      {
        "title": "Recent Errors",
        "type": "table",
        "query": "level:ERROR OR level:CRITICAL",
        "sort": ["@timestamp", "desc"],
        "columns": ["@timestamp", "message", "request_id", "endpoint"]
      }
    ]
  }
}
</code></pre>
<h2 id="advanced-monitoring">Advanced Monitoring<a class="headerlink" href="#advanced-monitoring" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>Not Implemented</strong>: The advanced monitoring features below are not currently implemented.</p>
</blockquote>
<h3 id="distributed-tracing-with-opentelemetry-potential-enhancement">Distributed Tracing with OpenTelemetry (Potential Enhancement)<a class="headerlink" href="#distributed-tracing-with-opentelemetry-potential-enhancement" title="Permanent link">¬∂</a></h3>
<blockquote>
<p><strong>Not Implemented</strong>: OpenTelemetry tracing is not currently configured.</p>
</blockquote>
<pre><code class="language-python"># Example: app/tracing.py (NOT IMPLEMENTED)
from opentelemetry import trace
from opentelemetry.exporter.jaeger.thrift import JaegerExporter
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor
from opentelemetry.instrumentation.httpx import HTTPXClientInstrumentor
from opentelemetry.instrumentation.redis import RedisInstrumentor

def setup_tracing():
    """Configure OpenTelemetry tracing."""

    # Set up tracer
    trace.set_tracer_provider(TracerProvider())
    tracer = trace.get_tracer(__name__)

    # Configure Jaeger exporter
    jaeger_exporter = JaegerExporter(
        agent_host_name="localhost",
        agent_port=6831,
    )

    # Add span processor
    span_processor = BatchSpanProcessor(jaeger_exporter)
    trace.get_tracer_provider().add_span_processor(span_processor)

    # Instrument FastAPI
    FastAPIInstrumentor.instrument()

    # Instrument HTTP clients
    HTTPXClientInstrumentor.instrument()

    # Instrument Redis
    RedisInstrumentor.instrument()
</code></pre>
<h3 id="custom-metrics-potential-enhancement">Custom Metrics (Potential Enhancement)<a class="headerlink" href="#custom-metrics-potential-enhancement" title="Permanent link">¬∂</a></h3>
<blockquote>
<p><strong>Not Implemented</strong>: Custom business metrics are not currently tracked.</p>
</blockquote>
<pre><code class="language-python"># Example: app/custom_metrics.py (NOT IMPLEMENTED)
from prometheus_client import Counter, Histogram, Gauge
import time
import functools

# Business metrics
SUMMONER_LOOKUPS = Counter(
    'lolstonks_summoner_lookups_total',
    'Total number of summoner lookups',
    ['region', 'source_type']
)

MATCH_LOOKUPS = Counter(
    'lolstonks_match_lookups_total',
    'Total number of match lookups',
    ['region', 'queue_type']
)

API_KEY_USAGE = Counter(
    'lolstonks_api_key_requests_total',
    'Total requests to Riot API',
    ['endpoint', 'status_code']
)

RATE_LIMIT_HITS = Counter(
    'lolstonks_rate_limit_hits_total',
    'Number of rate limit hits',
    ['endpoint', 'region']
)

def timed(histogram):
    """Decorator to measure function execution time."""
    def decorator(func):
        @functools.wraps(func)
        async def wrapper(*args, **kwargs):
            start_time = time.time()
            try:
                result = await func(*args, **kwargs)
                histogram.observe(time.time() - start_time)
                return result
            except Exception as e:
                histogram.observe(time.time() - start_time)
                raise
        return wrapper
    return decorator
</code></pre>
<h2 id="alerting">Alerting<a class="headerlink" href="#alerting" title="Permanent link">¬∂</a></h2>
<blockquote>
<p><strong>Not Implemented</strong>: Alerting is not currently configured. The examples below show potential configurations.</p>
</blockquote>
<h3 id="alert-configuration-example">Alert Configuration (Example)<a class="headerlink" href="#alert-configuration-example" title="Permanent link">¬∂</a></h3>
<pre><code class="language-yaml"># alerts.yml
groups:
  - name: lolstonks_critical
    rules:
      - alert: ServiceDown
        expr: up{job="lolstonks-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "LOLStonks API Gateway is down"
          description: "Service has been down for more than 1 minute"

      - alert: HighErrorRate
        expr: rate(lolstonks_requests_total{status!~"2.."}[5m]) / rate(lolstonks_requests_total[5m]) &gt; 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }}"

  - name: lolstonks_warnings
    rules:
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(lolstonks_request_duration_seconds_bucket[5m])) &gt; 1.0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }}s"

      - alert: LowCacheHitRate
        expr: lolstonks_cache_hit_rate &lt; 0.7
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }}"
</code></pre>
<h3 id="notification-channels">Notification Channels<a class="headerlink" href="#notification-channels" title="Permanent link">¬∂</a></h3>
<pre><code class="language-yaml"># alertmanager.yml
global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@yourdomain.com'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'

receivers:
  - name: 'web.hook'
    email_configs:
      - to: 'team@yourdomain.com'
        subject: '[LOLStonks Alert] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          {{ end }}

    slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#alerts'
        title: 'LOLStonks Alert'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
</code></pre>
<hr/>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">¬∂</a></h2>
<p>This document outlines <strong>best practices and potential implementations</strong> for comprehensive monitoring.</p>
<p><strong>Current State</strong>: The API Gateway has basic logging (Loguru) and a simple health check endpoint.</p>
<p><strong>Future Enhancements</strong>: Implementing Prometheus metrics, Grafana dashboards, ELK stack, and OpenTelemetry would provide full observability and enable proactive issue detection and performance optimization.</p>
<p>For the actual implementation status, see <a href="../implementation-status/">Implementation Status</a>.</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.indexes", "toc.follow", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
<script>
        // Enhanced Mermaid Interactivity for LOLStonks Documentation
        (function() {
            'use strict';

            console.log('Initializing Mermaid interactivity...');

            // Wait for DOM to be ready and Mermaid diagrams to render
            const waitForMermaid = () => {
                const mermaidElements = document.querySelectorAll('.mermaid');
                console.log('Found Mermaid elements:', mermaidElements.length);

                if (mermaidElements.length === 0) {
                    console.log('No Mermaid elements found, retrying in 2 seconds...');
                    setTimeout(waitForMermaid, 2000);
                    return;
                }

                mermaidElements.forEach((element, index) => {
                    const id = element.id || 'mermaid-diagram-' + index;
                    element.setAttribute('id', id);

                    // Wait for the diagram to be rendered as SVG
                    const waitForSVG = () => {
                        const svg = element.querySelector('svg');
                        if (svg) {
                            console.log('SVG found for element:', id);
                            addInteractivityToDiagram(element, id);
                        } else {
                            console.log('SVG not found yet for element:', id, 'retrying...');
                            setTimeout(waitForSVG, 500);
                        }
                    };

                    waitForSVG();
                });
            };

            const addInteractivityToDiagram = (element, id) => {
                // Add interactive controls container
                if (!element.previousSibling) {
                    const controls = createInteractiveControls(id, element);
                    element.parentNode.insertBefore(controls, element);
                }

                // Add zoom controls
                addZoomControls(element, id);

                // Add click handlers
                addClickHandlers(element);

                // Add tooltips
                addTooltips(element);

                // Make responsive
                makeResponsive(element);

                // Add pan and zoom
                addPanAndZoom(element, id);
            };

            const createInteractiveControls = (id, element) => {
                const controls = document.createElement('div');
                controls.className = 'mermaid-controls';
                controls.style.cssText = `
                    margin: 10px 0;
                    padding: 10px;
                    background: #f5f5f5;
                    border-radius: 5px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    flex-wrap: wrap;
                    gap: 10px;
                    font-size: 14px;
                    font-family: Arial, sans-serif;
                `;

                // Zoom controls
                const zoomControls = document.createElement('div');
                zoomControls.innerHTML = `
                    <span style="font-weight: bold;">üîç Zoom:</span>
                    <button onclick="zoomDiagram('${id}', 1.2)" style="margin: 0 2px; padding: 4px 8px; background: #1976d2; color: white; border: none; border-radius: 3px; cursor: pointer;">+</button>
                    <button onclick="zoomDiagram('${id}', 0.8)" style="margin: 0 2px; padding: 4px 8px; background: #1976d2; color: white; border: none; border-radius: 3px; cursor: pointer;">‚àí</button>
                    <button onclick="resetZoom('${id}')" style="margin: 0 2px; padding: 4px 8px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;">Reset</button>
                `;

                // Navigation info
                const navInfo = document.createElement('div');
                navInfo.innerHTML = `<span style="color: #666;">üñ±Ô∏è Click nodes for details ‚Ä¢ Scroll to zoom ‚Ä¢ Drag to pan</span>`;

                // Fullscreen button
                const fullscreenBtn = document.createElement('button');
                fullscreenBtn.textContent = '‚õ∂ Fullscreen';
                fullscreenBtn.style.cssText = `
                    padding: 4px 12px;
                    background: #388e3c;
                    color: white;
                    border: none;
                    border-radius: 3px;
                    cursor: pointer;
                `;
                fullscreenBtn.onclick = () => toggleFullscreen(id, element);

                // Download button
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = 'üì• Download';
                downloadBtn.style.cssText = `
                    padding: 4px 12px;
                    background: #ff9800;
                    color: white;
                    border: none;
                    border-radius: 3px;
                    cursor: pointer;
                `;
                downloadBtn.onclick = () => downloadDiagram(id, element);

                controls.appendChild(zoomControls);
                controls.appendChild(navInfo);
                controls.appendChild(fullscreenBtn);
                controls.appendChild(downloadBtn);

                return controls;
            };

            const addZoomControls = (element, id) => {
                element.style.transform = 'scale(1)';
                element.style.transformOrigin = 'center top';
                element.style.transition = 'transform 0.3s ease';
                element.dataset.originalTransform = 'scale(1)';
                element.dataset.currentZoom = '1';
            };

            const addPanAndZoom = (element, id) => {
                const svg = element.querySelector('svg');
                if (!svg) return;

                let isPanning = false;
                let startX = 0, startY = 0, translateX = 0, translateY = 0;

                // Mouse wheel zoom
                element.addEventListener('wheel', function(e) {
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        const delta = e.deltaY > 0 ? 0.9 : 1.1;
                        zoomDiagram(id, delta);
                    }
                });

                // Pan functionality
                svg.style.cursor = 'grab';
                svg.addEventListener('mousedown', function(e) {
                    if (e.button === 0 && !e.shiftKey) {
                        isPanning = true;
                        startX = e.clientX - translateX;
                        startY = e.clientY - translateY;
                        svg.style.cursor = 'grabbing';
                        e.preventDefault();
                    }
                });

                document.addEventListener('mousemove', function(e) {
                    if (isPanning) {
                        translateX = e.clientX - startX;
                        translateY = e.clientY - startY;
                        const currentZoom = parseFloat(element.dataset.currentZoom || 1);
                        svg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
                    }
                });

                document.addEventListener('mouseup', function() {
                    isPanning = false;
                    svg.style.cursor = 'grab';
                });

                // Touch support for mobile
                let touchStartDistance = 0;
                let touchStartZoom = 1;

                element.addEventListener('touchstart', function(e) {
                    if (e.touches.length === 2) {
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        touchStartDistance = Math.sqrt(dx * dx + dy * dy);
                        touchStartZoom = parseFloat(element.dataset.currentZoom || 1);
                    }
                });

                element.addEventListener('touchmove', function(e) {
                    if (e.touches.length === 2) {
                        const dx = e.touches[0].clientX - e.touches[1].clientX;
                        const dy = e.touches[0].clientY - e.touches[1].clientY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const scale = Math.max(0.5, Math.min(3, touchStartZoom * (distance / touchStartDistance)));
                        element.dataset.currentZoom = scale;
                        const svg = element.querySelector('svg');
                        const currentZoom = parseFloat(element.dataset.currentZoom || 1);
                        svg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentZoom})`;
                    }
                });
            };

            const addClickHandlers = (element) => {
                const svg = element.querySelector('svg');
                if (!svg) return;

                const clickableElements = svg.querySelectorAll('g.node, g.edgePath, .cluster');
                clickableElements.forEach(el => {
                    el.style.cursor = 'pointer';
                    el.addEventListener('click', function(e) {
                        if (!e.shiftKey && !e.ctrlKey) {
                            e.preventDefault();
                            showNodeDetails(el, element);
                        }
                    });
                });
            };

            const addTooltips = (element) => {
                const svg = element.querySelector('svg');
                if (!svg) return;

                const nodes = svg.querySelectorAll('g.node');
                nodes.forEach(node => {
                    const rect = node.querySelector('rect');
                    const text = node.querySelector('text');
                    if (rect && text) {
                        node.title = text.textContent + ' - Click for more information';

                        node.addEventListener('mouseenter', function() {
                            rect.style.filter = 'brightness(1.2)';
                            rect.style.transition = 'filter 0.2s ease';
                        });

                        node.addEventListener('mouseleave', function() {
                            rect.style.filter = 'brightness(1)';
                        });
                    }
                });
            };

            const makeResponsive = (element) => {
                const svg = element.querySelector('svg');
                if (!svg) return;

                svg.style.maxWidth = '100%';
                svg.style.height = 'auto';
                svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');

                const resizeObserver = new ResizeObserver(() => {
                    adjustDiagramSize(element);
                });
                resizeObserver.observe(element);
            };

            const adjustDiagramSize = (element) => {
                const svg = element.querySelector('svg');
                if (!svg) return;

                const container = element.parentElement;
                const containerWidth = container.clientWidth;

                if (containerWidth < 800) {
                    const mobileZoom = Math.max(0.5, containerWidth / 800);
                    element.dataset.currentZoom = mobileZoom;
                    const translateMatch = svg.style.transform.match(/translate\(([^)]+)px/);
                    const translate = translateMatch ? translateMatch[1] : '0px, 0px';
                    svg.style.transform = `translate(${translate}) scale(${mobileZoom})`;
                }
            };

            const showNodeDetails = (nodeElement, diagramElement) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    max-width: 600px;
                    max-height: 80%;
                    overflow-y: auto;
                `;

                const text = nodeElement.querySelector('text');
                const title = text ? text.textContent : 'Node Details';

                content.innerHTML = `
                    <h3>${title}</h3>
                    <p><strong>Diagram:</strong> ${diagramElement.closest('h1, h2, h3, h4, h5, h6')?.textContent || 'Architecture Diagram'}</p>
                    <p><strong>Component Type:</strong> ${getNodeInfo(nodeElement).type}</p>
                    <p>${getNodeInfo(nodeElement).description}</p>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="
                        margin-top: 15px;
                        padding: 8px 16px;
                        background: #1976d2;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                    ">Close</button>
                `;

                modal.appendChild(content);
                modal.appendChild(document.createElement('button'));
                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };

                document.body.appendChild(modal);
            };

            const getNodeInfo = (nodeElement) => {
                const text = nodeElement.querySelector('text')?.textContent?.toLowerCase() || '';

                if (text.includes('api') || text.includes('gateway')) {
                    return {
                        type: 'API Component',
                        description: 'This component handles API requests, routing, and response processing in the LOLStonks Gateway.'
                    };
                } else if (text.includes('cache') || text.includes('redis')) {
                    return {
                        type: 'Cache Layer',
                        description: 'This component provides caching functionality to improve API response times and reduce external API calls.'
                    };
                } else if (text.includes('rate') || text.includes('limit')) {
                    return {
                        type: 'Rate Limiter',
                        description: 'This component enforces rate limits to prevent API abuse and ensure fair usage across all clients.'
                    };
                } else if (text.includes('auth') || text.includes('security')) {
                    return {
                        type: 'Security Component',
                        description: 'This component handles authentication, authorization, and security validation for API requests.'
                    };
                } else if (text.includes('provider') || text.includes('riot')) {
                    return {
                        type: 'External Provider',
                        description: 'This component interfaces with external APIs (like Riot Games API) to fetch game data.'
                    };
                } else {
                    return {
                        type: 'System Component',
                        description: 'This component is part of the LOLStonks API Gateway architecture. Click on different components to explore the system design.'
                    };
                }
            };

            // Global functions for button controls
            window.zoomDiagram = function(id, factor) {
                const element = document.getElementById(id);
                if (!element) return;

                const currentZoom = parseFloat(element.dataset.currentZoom || 1);
                const newZoom = Math.max(0.1, Math.min(3, currentZoom * factor));

                const svg = element.querySelector('svg');
                const currentTransform = svg.style.transform || '';
                const translateMatch = currentTransform.match(/translate\(([^)]+)px/);
                const translate = translateMatch ? translateMatch[1] : '0px, 0px';

                svg.style.transform = `translate(${translate}) scale(${newZoom})`;
                element.dataset.currentZoom = newZoom;
            };

            window.resetZoom = function(id) {
                const element = document.getElementById(id);
                if (!element) return;

                const svg = element.querySelector('svg');
                svg.style.transform = 'translate(0px, 0px) scale(1)';
                element.dataset.currentZoom = '1';
            };

            window.toggleFullscreen = function(id, element) {
                if (element.style.position === 'fixed') {
                    // Exit fullscreen
                    element.style.position = '';
                    element.style.top = '';
                    element.style.left = '';
                    element.style.width = '';
                    element.style.height = '';
                    element.style.zIndex = '';
                    element.style.backgroundColor = '';
                    element.style.padding = '';
                    element.style.overflow = '';
                    resetZoom(id);
                } else {
                    // Enter fullscreen
                    element.style.position = 'fixed';
                    element.style.top = '0';
                    element.style.left = '0';
                    element.style.width = '100vw';
                    element.style.height = '100vh';
                    element.style.zIndex = '999';
                    element.style.backgroundColor = 'white';
                    element.style.padding = '20px';
                    element.style.overflow = 'auto';
                    zoomDiagram(id, 1.5);
                }
            };

            window.downloadDiagram = function(id, element) {
                const svg = element.querySelector('svg');
                if (!svg) return;

                const svgData = new XMLSerializer().serializeToString(svg);
                const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                const svgUrl = URL.createObjectURL(svgBlob);

                const downloadLink = document.createElement('a');
                downloadLink.href = svgUrl;
                downloadLink.download = `${id || 'diagram'}-${Date.now()}.svg`;
                downloadLink.click();

                URL.revokeObjectURL(svgUrl);
            };

            // Initialize everything
            waitForMermaid();

        })();
    </script>
</body>
</html>